<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Clientes - Visitas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="../css/styles.css" rel="stylesheet">
  <style>
    #map { height: 300px; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Visitas</a>
    <div class="d-flex">
      <button id="btnDashboard" class="btn btn-outline-secondary me-2">Dashboard</button>
      <button id="btnVisits" class="btn btn-outline-secondary me-2">Visitas</button>
      <button id="btnLogout" class="btn btn-danger">Cerrar sesión</button>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Clientes</h4>
    <button id="btnNew" class="btn btn-primary">Nuevo Cliente</button>
  </div>

  <div id="alert-placeholder"></div>

  <table class="table table-striped" id="clientsTable">
    <thead>
      <tr><th>ID</th><th>Nombre</th><th>Dirección</th><th>Coordenadas</th><th>Email</th><th>Acciones</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal (crear/editar) -->
<div class="modal fade" id="clientModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="clientForm">
        <div class="modal-header">
          <h5 class="modal-title" id="clientModalTitle">Cliente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="clientId">
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input id="clientName" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Dirección</label>
            <input id="clientAddress" class="form-control">
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Latitud</label>
              <input id="clientLat" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Longitud</label>
              <input id="clientLng" class="form-control">
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input id="clientEmail" type="email" class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label">Seleccionar coordenadas (opcional)</label>
            <div id="map" class="border"></div>
            <small class="text-muted">Haz clic en el mapa para elegir lat/lng.</small>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="../js/app.js"></script>
<script src="../js/api.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Google Maps optional: only if you set API key in app.js __env.GOOGLE_MAPS_API_KEY -->
<script>
  // clients.js embedded
  (function(){
    if (!sessionStorage.getItem('jwt')) { window.location = '../index.html'; return; }

    const tableBody = document.querySelector('#clientsTable tbody');
    const alertPlace = document.getElementById('alert-placeholder');
    const clientModalEl = document.getElementById('clientModal');
    const bsModal = new bootstrap.Modal(clientModalEl);
    let map, marker;

    document.getElementById('btnLogout').addEventListener('click', ()=> { sessionStorage.clear(); window.location='../index.html'; });
    document.getElementById('btnDashboard').addEventListener('click', ()=> window.location='dashboard.html');
    document.getElementById('btnNew').addEventListener('click', ()=> openModal());

    async function loadClients(){
      try {
        const clients = await apiGet('/clients');
        renderTable(clients);
      } catch (e) {
        showAlert(e.message,'danger');
      }
    }

    function renderTable(clients){
      tableBody.innerHTML = clients.map(c=>`
        <tr>
          <td>${c.id}</td>
          <td>${escapeHtml(c.name||'')}</td>
          <td>${escapeHtml(c.address||'')}</td>
          <td>${c.latitude||''}, ${c.longitude||''}</td>
          <td>${escapeHtml(c.email||'')}</td>
          <td>
            <button class="btn btn-sm btn-primary btn-edit" data-id="${c.id}">Editar</button>
            <button class="btn btn-sm btn-danger btn-delete" data-id="${c.id}">Borrar</button>
          </td>
        </tr>
      `).join('');
      document.querySelectorAll('.btn-edit').forEach(b=> b.addEventListener('click', e=> editClient(e.target.dataset.id)));
      document.querySelectorAll('.btn-delete').forEach(b=> b.addEventListener('click', e=> deleteClient(e.target.dataset.id)));
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    async function deleteClient(id){
      if (!confirm('Borrar cliente ID ' + id + '?')) return;
      try {
        await apiDelete('/clients/' + id);
        showAlert('Cliente borrado','success');
        loadClients();
      } catch (e) { showAlert(e.message,'danger'); }
    }

    async function editClient(id){
      try {
        const c = await apiGet('/clients/' + id);
        openModal(c);
      } catch (e) { showAlert(e.message,'danger'); }
    }

    function openModal(client){
      document.getElementById('clientId').value = client?.id || '';
      document.getElementById('clientName').value = client?.name || '';
      document.getElementById('clientAddress').value = client?.address || '';
      document.getElementById('clientLat').value = client?.latitude ?? '';
      document.getElementById('clientLng').value = client?.longitude ?? '';
      document.getElementById('clientEmail').value = client?.email || '';
      document.getElementById('clientModalTitle').innerText = client ? 'Editar Cliente' : 'Nuevo Cliente';
      bsModal.show();
      // init map
      setTimeout(()=> initMap(client),300);
    }

    document.getElementById('clientForm').addEventListener('submit', async (evt)=>{
      evt.preventDefault();
      const id = document.getElementById('clientId').value;
      const payload = {
        name: document.getElementById('clientName').value,
        address: document.getElementById('clientAddress').value,
        latitude: parseFloat(document.getElementById('clientLat').value) || null,
        longitude: parseFloat(document.getElementById('clientLng').value) || null,
        email: document.getElementById('clientEmail').value
      };
      try {
        if (id) {
          await apiPut('/clients/' + id, payload);
          showAlert('Cliente actualizado','success');
        } else {
          await apiPost('/clients', payload);
          showAlert('Cliente creado','success');
        }
        bsModal.hide();
        loadClients();
      } catch (e) {
        showAlert(e.message,'danger');
      }
    });

    function showAlert(msg,type='info'){
      alertPlace.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
      setTimeout(()=> alertPlace.innerHTML='',4000);
    }

    // Map handling
    function initMap(client){
      const key = (window.__env && window.__env.GOOGLE_MAPS_API_KEY) ? window.__env.GOOGLE_MAPS_API_KEY : '';
      const lat = parseFloat(document.getElementById('clientLat').value) || 14.5586;
      const lng = parseFloat(document.getElementById('clientLng').value) || -90.7336;
      if (!key) {
        // no maps key -> display empty box with message
        document.getElementById('map').innerHTML = '<div class="p-3 text-muted">Configura GOOGLE_MAPS_API_KEY en js/app.js para usar el mapa</div>';
        return;
      }
      if (typeof google === 'undefined' || !google.maps) {
        // load script dynamically
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${key}`;
        script.onload = ()=> createMap(lat,lng,client);
        document.head.appendChild(script);
      } else {
        createMap(lat,lng,client);
      }
    }

    function createMap(lat,lng,client){
      const center = { lat: lat, lng: lng };
      map = new google.maps.Map(document.getElementById('map'), { center, zoom: 13 });
      marker = new google.maps.Marker({ position: center, map: map, draggable: true });
      if (client && client.latitude && client.longitude) {
        map.setCenter({lat: client.latitude, lng: client.longitude});
        marker.setPosition({lat: client.latitude, lng: client.longitude});
      }
      // update inputs on marker drag or map click
      marker.addListener('dragend', ()=> {
        const p = marker.getPosition();
        document.getElementById('clientLat').value = p.lat().toFixed(6);
        document.getElementById('clientLng').value = p.lng().toFixed(6);
      });
      map.addListener('click', (ev)=> {
        const p = ev.latLng;
        marker.setPosition(p);
        document.getElementById('clientLat').value = p.lat().toFixed(6);
        document.getElementById('clientLng').value = p.lng().toFixed(6);
      });
    }

    document.getElementById('btnLogout').addEventListener('click', ()=> { sessionStorage.clear(); window.location='../index.html'; });
document.getElementById('btnDashboard').addEventListener('click', ()=> window.location='dashboard.html');
document.getElementById('btnVisits').addEventListener('click', ()=> window.location='visits.html');

    // initial load
    loadClients();
  })();
</script>
</body>
</html>