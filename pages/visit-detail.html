<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Detalle de Visita</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="../css/styles.css" rel="stylesheet">
  <style>#map { height: 400px; }</style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Visitas</a>
    <div class="d-flex">
      <button id="btnBack" class="btn btn-outline-secondary me-2">Volver</button>
      <button id="btnLogout" class="btn btn-danger">Cerrar sesión</button>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <h4>Detalle de Visita</h4>
  <div id="alert-placeholder"></div>

  <div class="card mb-3">
    <div class="card-body">
      <p><strong>ID:</strong> <span id="vId"></span></p>
      <p><strong>Cliente ID:</strong> <span id="vClient"></span></p>
      <p><strong>Técnico ID:</strong> <span id="vTech"></span></p>
      <p><strong>Programada:</strong> <span id="vScheduled"></span></p>
      <p><strong>Ingreso:</strong> <span id="vCheckIn"></span></p>
      <p><strong>Egreso:</strong> <span id="vCheckOut"></span></p>
      <p><strong>Notas:</strong> <span id="vNotes"></span></p>
      <div class="mb-2">
        <button id="btnCheckIn" class="btn btn-success">Registrar ingreso</button>
        <button id="btnCheckOut" class="btn btn-warning">Registrar egreso</button>
        <button id="btnFinish" class="btn btn-primary">Finalizar y enviar informe</button>
        <button id="btnDownload" class="btn btn-secondary">Descargar PDF</button>
        <a id="linkDirections" class="btn btn-info text-white" target="_blank">Cómo llegar</a>
      </div>
    </div>
  </div>

  <div id="map" class="mb-4 border"></div>
</div>

<script src="../js/app.js"></script>
<script src="../js/api.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
  if (!sessionStorage.getItem('jwt')) { window.location = '../index.html'; return; }

  const params = new URLSearchParams(window.location.search);
  const id = params.get('id');
  if (!id) { alert('ID de visita faltante'); window.location='visits.html'; return; }

  const el = {
    vId: document.getElementById('vId'),
    vClient: document.getElementById('vClient'),
    vTech: document.getElementById('vTech'),
    vScheduled: document.getElementById('vScheduled'),
    vCheckIn: document.getElementById('vCheckIn'),
    vCheckOut: document.getElementById('vCheckOut'),
    vNotes: document.getElementById('vNotes'),
    alert: document.getElementById('alert-placeholder'),
    btnCheckIn: document.getElementById('btnCheckIn'),
    btnCheckOut: document.getElementById('btnCheckOut'),
    btnFinish: document.getElementById('btnFinish'),
    btnDownload: document.getElementById('btnDownload'),
    linkDirections: document.getElementById('linkDirections')
  };

  document.getElementById('btnBack').addEventListener('click', ()=> window.location='visits.html');
  document.getElementById('btnLogout').addEventListener('click', ()=> { sessionStorage.clear(); window.location='../index.html'; });

  let visitData = null;
  let map, marker;

  function showAlert(msg,type='info'){ el.alert.innerHTML = `<div class="alert alert-${type}">${msg}</div>`; setTimeout(()=> el.alert.innerHTML='',4000); }

  async function load() {
    try {
      visitData = await apiGet('/visits/' + id);
      render();
      initMap();
    } catch (e) { showAlert(e.message,'danger'); }
  }

  function render(){
    el.vId.innerText = visitData.id;
    el.vClient.innerText = visitData.clientId;
    el.vTech.innerText = visitData.technicianId;
    el.vScheduled.innerText = visitData.scheduledAt ? visitData.scheduledAt.replace('T',' ') : '';
    el.vCheckIn.innerText = visitData.checkIn ? visitData.checkIn.replace('T',' ') : '-';
    el.vCheckOut.innerText = visitData.checkOut ? visitData.checkOut.replace('T',' ') : '-';
    el.vNotes.innerText = visitData.notes || '';
    // directions link (uses client coords if available)
    const lat = visitData.checkInLat || visitData.checkOutLat || visitData.checkInLat || visitData.clientLat || visitData.clientLatitude || '';
    const lng = visitData.checkInLng || visitData.checkOutLng || visitData.clientLng || visitData.clientLongitude || '';
    if (lat && lng) {
      el.linkDirections.href = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
      el.linkDirections.style.display = 'inline-block';
    } else {
      el.linkDirections.style.display = 'none';
    }
  }

  async function registerCheck(kind){
    try {
      const coords = await getCurrentCoords();
      if (!coords) showAlert('No se obtuvo posición (geolocation). Se registrará sin coordenadas.','warning');
      if (kind==='in') {
        visitData.checkIn = new Date().toISOString();
        if (coords) { visitData.checkInLat = coords.lat; visitData.checkInLng = coords.lng; }
      } else {
        visitData.checkOut = new Date().toISOString();
        if (coords) { visitData.checkOutLat = coords.lat; visitData.checkOutLng = coords.lng; }
      }
      await apiPut('/visits/' + id, visitData);
      showAlert(kind==='in' ? 'Ingreso registrado':'Egreso registrado','success');
      await load();
    } catch (e){ showAlert(e.message,'danger'); }
  }

  el.btnCheckIn.addEventListener('click', ()=> { if (confirm('Registrar ingreso?')) registerCheck('in'); });
  el.btnCheckOut.addEventListener('click', ()=> { if (confirm('Registrar egreso?')) registerCheck('out'); });

  el.btnFinish.addEventListener('click', async ()=> {
    if (!confirm('Finalizar visita y enviar informe?')) return;
    try {
      // if client email not in visitData, prompt
      let email = visitData.clientEmail || visitData.email || prompt('Email del cliente:');
      if (!email) { showAlert('Email requerido','danger'); return; }
      await apiPost(`/visits/${id}/finish`, { email });
      showAlert('Visita finalizada y reporte enviado','success');
      await load();
    } catch (e) { showAlert(e.message,'danger'); }
  });

  el.btnDownload.addEventListener('click', async ()=> {
    try {
      // request binary PDF
      const token = sessionStorage.getItem('jwt');
      const res = await fetch((window.__env && window.__env.API_BASE_URL ? window.__env.API_BASE_URL : 'http://localhost:8081') + `/visits/${id}/report`, {
        method: 'GET',
        headers: { 'Authorization': token ? ('Bearer ' + token) : '' }
      });
      if (!res.ok) { throw new Error('Error al descargar el PDF'); }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `visita_${id}.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch (e) { showAlert(e.message,'danger'); }
  });

  function getCurrentCoords(){
    return new Promise((resolve)=> {
      if (!navigator.geolocation) return resolve(null);
      navigator.geolocation.getCurrentPosition(pos=>{
        resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude });
      }, ()=> resolve(null), { timeout: 8000 });
    });
  }

  function initMap(){
    const key = (window.__env && window.__env.GOOGLE_MAPS_API_KEY) ? window.__env.GOOGLE_MAPS_API_KEY : '';
    const lat = visitData.checkInLat || visitData.checkOutLat || visitData.clientLat || visitData.latitude || 14.5586;
    const lng = visitData.checkInLng || visitData.checkOutLng || visitData.clientLng || visitData.longitude || -90.7336;
    if (!key) {
      document.getElementById('map').innerHTML = '<div class="p-3 text-muted">Configura GOOGLE_MAPS_API_KEY en js/app.js para ver el mapa</div>';
      return;
    }
    if (typeof google === 'undefined' || !google.maps) {
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${key}`;
      script.onload = ()=> createMap(lat,lng);
      document.head.appendChild(script);
    } else {
      createMap(lat,lng);
    }
  }

  function createMap(lat,lng){
    const center = { lat: parseFloat(lat), lng: parseFloat(lng) };
    map = new google.maps.Map(document.getElementById('map'), { center, zoom: 15 });
    marker = new google.maps.Marker({ position: center, map: map });
  }

  load();
})();
</script>
</body>
</html>